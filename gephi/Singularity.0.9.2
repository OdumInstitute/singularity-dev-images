Bootstrap: yum
OSVersion: 7
MirrorURL: http://mirror.centos.org/centos-%{OSVERSION}/%{OSVERSION}/os/$basearch/
Include: yum

%help
  Gephi - The Open Graph Viz Platform
  Version 0.9.2

  Usage:
  $ singularity run --app gephi gephi-gephi-0.9.2.simg [args]
  $ singularity run gephi gephi-gephi-0.9.2.simg [args]

%setup

%files

%labels
  Maintainer Michael J. Stealey
  Maintainer_Email stealey@renci.org
  Gephi_Version 0.9.2
  Java_Version 1.8.0

%environment
  JAVA_VERSION=1.8.0
  GEPHI_VERSION=0.9.2

%post
  export JAVA_VERSION=1.8.0
  export GEPHI_VERSION=0.9.2
  yum -y install \
    tar \
    which \
    gzip \
    libXext \
    libXrender \
    libXtst \
    mesa-libGL \
    mesa-libGLES \
    mesa-dri-drivers \
    libXxf86vm \
    libXinerama \
    libXrandr \
    libXcursor

  # install java 1.8.0_xxx
  RPM_URL=$(curl -s https://lv.binarybabel.org/catalog-api/java/jdk8.txt?p=downloads.rpm)
  curl -LOH 'Cookie: oraclelicense=accept-securebackup-cookie' "${RPM_URL}"
  yum -y localinstall jdk-*.rpm
  rm -f jdk-*.rpm
  JAVA_DIR='/usr/java/'$(ls /usr/java/ | grep jdk)
  export JAVA_HOME=${JAVA_DIR}
  export JRE_HOME=${JAVA_DIR}/jre/bin
  export PATH=${JAVA_DIR}/bin:$PATH

  # install gephi
  cd /usr/local
  curl -L https://github.com/gephi/gephi/releases/download/v${GEPHI_VERSION}/gephi-${GEPHI_VERSION}-linux.tar.gz -o gephi-${GEPHI_VERSION}-linux.tar.gz
  tar xzvf gephi-${GEPHI_VERSION}-linux.tar.gz
  rm -f gephi-${GEPHI_VERSION}-linux.tar.gz
  export PATH=/usr/local/gephi-${GEPHI_VERSION}/bin:$PATH
  cd /

  # create init.sh
  cat > /usr/local/init.sh <<EOF
#!/usr/bin/env bash
export JAVA_HOME=${JAVA_DIR}
export JRE_HOME=${JAVA_DIR}/jre/bin
export PATH=${JAVA_DIR}/bin:$PATH
export PATH=/usr/local/gephi-${GEPHI_VERSION}/bin:\$PATH
EOF
  chmod a+x /usr/local/init.sh

# Commenting out, as a test, after installing libXrandr.
#   # create gephi.conf
#   cat > /usr/local/gephi-${GEPHI_VERSION}/etc/gephi.conf <<EOF
# # \${HOME} will be replaced by user home directory according to platform
# default_userdir="\${HOME}/.\${APPNAME}/0.9.2/dev"
# default_mac_userdir="\${HOME}/Library/Application Support/\${APPNAME}/0.9.2/dev"
# 
# # options used by the launcher by default, can be overridden by explicit
# # command line switches
# default_options="--branding gephi -J-Xms64m -J-Xmx512m -J-Xverify:none -J-Dsun.java2d.noddraw=true -J-Dsun.awt.noerasebackground=true -J-Dnetbeans.indexing.noFileRefresh=true -J-Dplugin.manager.check.interval=EVERY_DAY -J-Dsun.java2d.xrender=false -J-Dawt.useSystemAAFontSettings=off"
# # for development purposes you may wish to append: -J-Dnetbeans.logger.console=true -J-ea
# 
# # default location of JDK/JRE, can be overridden by using --jdkhome <dir> switch
# #jdkhome="/path/to/jdk"
# 
# # clusters' paths separated by path.separator (semicolon on Windows, colon on Unices)
# #extra_clusters=
# EOF

%apprun gephi
  source /usr/local/init.sh
  exec gephi "${@}"

%runscript
  source /usr/local/init.sh
  exec "${@}"

%test
  source /usr/local/init.sh
  env
